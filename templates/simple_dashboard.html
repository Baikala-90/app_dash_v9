<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œì£¼ëŸ‰ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .chart-container {
            height: 400px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <h1><i class="fas fa-chart-line me-3"></i>ë°œì£¼ëŸ‰ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="mb-0">Flask ê¸°ë°˜ ì‹¤ì‹œê°„ ë°œì£¼ëŸ‰ ë¶„ì„ ì‹œìŠ¤í…œ</p>
        </div>
    </div>

    <div class="container">
        <!-- ìš”ì•½ í†µê³„ ì¹´ë“œ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="stat-number" id="total-volume">-</div>
                    <div class="stat-label">ì´ ë°œì£¼ëŸ‰</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="stat-number" id="avg-volume">-</div>
                    <div class="stat-label">í‰ê·  ë°œì£¼ëŸ‰</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="stat-number" id="total-days">-</div>
                    <div class="stat-label">ì´ ë°œì£¼ ì¼ìˆ˜</div>
                </div>
            </div>
        </div>

        <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“ˆ ì£¼ê°„ ë°œì£¼ëŸ‰ ë¹„êµ</h5>
                    </div>
                    <div class="card-body">
                        <div id="weekly-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“Š ì›”ê°„ ë°œì£¼ëŸ‰</h5>
                    </div>
                    <div class="card-body">
                        <div id="monthly-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“ˆ ì—°ë„ë³„ ì›”ê°„ ë°œì£¼ëŸ‰ ì¶”ì´</h5>
                    </div>
                    <div class="card-body">
                        <div id="yearly-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
        <div class="row">
            <div class="col-12 text-center">
                <button class="btn btn-warning btn-lg" onclick="refreshData()">
                    ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                </button>
                <p class="text-muted mt-2" id="last-update">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ë° ì°¨íŠ¸ ìƒì„±
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        function loadDashboardData() {
            // ìš”ì•½ í†µê³„ ë¡œë“œ
            fetch('/api/summary')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('ìš”ì•½ í†µê³„ ì˜¤ë¥˜:', data.error);
                        return;
                    }
                    document.getElementById('total-volume').textContent = data.total_volume.toLocaleString();
                    document.getElementById('avg-volume').textContent = data.avg_volume.toLocaleString();
                    document.getElementById('total-days').textContent = data.total_days.toLocaleString();
                })
                .catch(error => console.error('ìš”ì•½ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error));

            // ì£¼ê°„ ë¹„êµ ì°¨íŠ¸
            fetch('/api/weekly_comparison')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('ì£¼ê°„ ë¹„êµ ì˜¤ë¥˜:', data.error);
                        return;
                    }
                    
                    const weekdays = data.data.map(item => item.weekday);
                    const thisWeek = data.data.map(item => item.this_week);
                    const lastWeek = data.data.map(item => item.last_week);
                    
                    const trace1 = {
                        x: weekdays,
                        y: thisWeek,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'ì´ë²ˆ ì£¼',
                        line: {color: '#667eea', width: 3},
                        marker: {size: 8}
                    };
                    
                    const trace2 = {
                        x: weekdays,
                        y: lastWeek,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'ì§€ë‚œ ì£¼',
                        line: {color: '#764ba2', width: 3},
                        marker: {size: 8}
                    };
                    
                    const layout = {
                        title: `ì£¼ê°„ ë°œì£¼ëŸ‰ ë¹„êµ (ê¸°ì¤€ì¼: ${data.latest_date})`,
                        xaxis: {title: 'ìš”ì¼'},
                        yaxis: {title: 'ë°œì£¼ëŸ‰'},
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)'
                    };
                    
                    Plotly.newPlot('weekly-chart', [trace1, trace2], layout, {responsive: true});
                })
                .catch(error => console.error('ì£¼ê°„ ë¹„êµ ë¡œë“œ ì‹¤íŒ¨:', error));

            // ì›”ê°„ ë¹„êµ ì°¨íŠ¸
            fetch('/api/monthly_comparison')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('ì›”ê°„ ë¹„êµ ì˜¤ë¥˜:', data.error);
                        return;
                    }
                    
                    const months = data.data.map(item => item.month);
                    const volumes = data.data.map(item => item.volume);
                    
                    const trace = {
                        x: months,
                        y: volumes,
                        type: 'bar',
                        marker: {
                            color: volumes.map(v => v > Math.max(...volumes) * 0.8 ? '#28a745' : '#ffc107'),
                            line: {color: '#fff', width: 1}
                        }
                    };
                    
                    const layout = {
                        title: 'ì›”ê°„ ë°œì£¼ëŸ‰ (ìµœê·¼ 12ê°œì›”)',
                        xaxis: {title: 'ì›”'},
                        yaxis: {title: 'ë°œì£¼ëŸ‰'},
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)'
                    };
                    
                    Plotly.newPlot('monthly-chart', [trace], layout, {responsive: true});
                })
                .catch(error => console.error('ì›”ê°„ ë¹„êµ ë¡œë“œ ì‹¤íŒ¨:', error));

            // ì—°ë„ë³„ ì¶”ì´ ì°¨íŠ¸
            fetch('/api/yearly_trends')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('ì—°ë„ë³„ ì¶”ì´ ì˜¤ë¥˜:', data.error);
                        return;
                    }
                    
                    const traces = [];
                    const colors = ['#667eea', '#764ba2', '#f093fb'];
                    let colorIndex = 0;
                    
                    for (const [year, monthData] of Object.entries(data.data)) {
                        const months = Object.keys(monthData).map(Number).sort((a, b) => a - b);
                        const volumes = months.map(month => monthData[month]);
                        
                        traces.push({
                            x: months,
                            y: volumes,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: `${year}ë…„`,
                            line: {color: colors[colorIndex % colors.length], width: 3},
                            marker: {size: 6}
                        });
                        colorIndex++;
                    }
                    
                    const layout = {
                        title: 'ì—°ë„ë³„ ì›”ê°„ ë°œì£¼ëŸ‰ ì¶”ì´',
                        xaxis: {title: 'ì›”', tickmode: 'linear', tick0: 1, dtick: 1},
                        yaxis: {title: 'ë°œì£¼ëŸ‰'},
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)'
                    };
                    
                    Plotly.newPlot('yearly-chart', traces, layout, {responsive: true});
                })
                .catch(error => console.error('ì—°ë„ë³„ ì¶”ì´ ë¡œë“œ ì‹¤íŒ¨:', error));

            // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
            document.getElementById('last-update').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`;
        }

        function refreshData() {
            loadDashboardData();
        }

        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadDashboardData, 300000);
    </script>
</body>
</html>
