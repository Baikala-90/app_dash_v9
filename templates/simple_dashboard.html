<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발주량 대시보드</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .chart-container {
            height: 400px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <h1><i class="fas fa-chart-line me-3"></i>발주량 대시보드</h1>
            <p class="mb-0">Flask 기반 실시간 발주량 분석 시스템</p>
        </div>
    </div>

    <div class="container">
        <!-- 요약 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="stat-number" id="total-volume">-</div>
                    <div class="stat-label">총 발주량</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="stat-number" id="avg-volume">-</div>
                    <div class="stat-label">평균 발주량</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="stat-number" id="total-days">-</div>
                    <div class="stat-label">총 발주 일수</div>
                </div>
            </div>
        </div>

        <!-- 차트 섹션 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">📈 주간 발주량 비교</h5>
                    </div>
                    <div class="card-body">
                        <div id="weekly-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">📊 월간 발주량</h5>
                    </div>
                    <div class="card-body">
                        <div id="monthly-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">📈 연도별 월간 발주량 추이</h5>
                    </div>
                    <div class="card-body">
                        <div id="yearly-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 새로고침 버튼 -->
        <div class="row">
            <div class="col-12 text-center">
                <button class="btn btn-warning btn-lg" onclick="refreshData()">
                    🔄 데이터 새로고침
                </button>
                <p class="text-muted mt-2" id="last-update">마지막 업데이트: -</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 대시보드 데이터 로드 및 차트 생성
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        function loadDashboardData() {
            // 요약 통계 로드
            fetch('/api/summary')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('요약 통계 오류:', data.error);
                        return;
                    }
                    document.getElementById('total-volume').textContent = data.total_volume.toLocaleString();
                    document.getElementById('avg-volume').textContent = data.avg_volume.toLocaleString();
                    document.getElementById('total-days').textContent = data.total_days.toLocaleString();
                })
                .catch(error => console.error('요약 통계 로드 실패:', error));

            // 주간 비교 차트
            fetch('/api/weekly_comparison')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('주간 비교 오류:', data.error);
                        return;
                    }
                    
                    const weekdays = data.data.map(item => item.weekday);
                    const thisWeek = data.data.map(item => item.this_week);
                    const lastWeek = data.data.map(item => item.last_week);
                    
                    const trace1 = {
                        x: weekdays,
                        y: thisWeek,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: '이번 주',
                        line: {color: '#667eea', width: 3},
                        marker: {size: 8}
                    };
                    
                    const trace2 = {
                        x: weekdays,
                        y: lastWeek,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: '지난 주',
                        line: {color: '#764ba2', width: 3},
                        marker: {size: 8}
                    };
                    
                    const layout = {
                        title: `주간 발주량 비교 (기준일: ${data.latest_date})`,
                        xaxis: {title: '요일'},
                        yaxis: {title: '발주량'},
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)'
                    };
                    
                    Plotly.newPlot('weekly-chart', [trace1, trace2], layout, {responsive: true});
                })
                .catch(error => console.error('주간 비교 로드 실패:', error));

            // 월간 비교 차트
            fetch('/api/monthly_comparison')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('월간 비교 오류:', data.error);
                        return;
                    }
                    
                    const months = data.data.map(item => item.month);
                    const volumes = data.data.map(item => item.volume);
                    
                    const trace = {
                        x: months,
                        y: volumes,
                        type: 'bar',
                        marker: {
                            color: volumes.map(v => v > Math.max(...volumes) * 0.8 ? '#28a745' : '#ffc107'),
                            line: {color: '#fff', width: 1}
                        }
                    };
                    
                    const layout = {
                        title: '월간 발주량 (최근 12개월)',
                        xaxis: {title: '월'},
                        yaxis: {title: '발주량'},
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)'
                    };
                    
                    Plotly.newPlot('monthly-chart', [trace], layout, {responsive: true});
                })
                .catch(error => console.error('월간 비교 로드 실패:', error));

            // 연도별 추이 차트
            fetch('/api/yearly_trends')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('연도별 추이 오류:', data.error);
                        return;
                    }
                    
                    const traces = [];
                    const colors = ['#667eea', '#764ba2', '#f093fb'];
                    let colorIndex = 0;
                    
                    for (const [year, monthData] of Object.entries(data.data)) {
                        const months = Object.keys(monthData).map(Number).sort((a, b) => a - b);
                        const volumes = months.map(month => monthData[month]);
                        
                        traces.push({
                            x: months,
                            y: volumes,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: `${year}년`,
                            line: {color: colors[colorIndex % colors.length], width: 3},
                            marker: {size: 6}
                        });
                        colorIndex++;
                    }
                    
                    const layout = {
                        title: '연도별 월간 발주량 추이',
                        xaxis: {title: '월', tickmode: 'linear', tick0: 1, dtick: 1},
                        yaxis: {title: '발주량'},
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)'
                    };
                    
                    Plotly.newPlot('yearly-chart', traces, layout, {responsive: true});
                })
                .catch(error => console.error('연도별 추이 로드 실패:', error));

            // 마지막 업데이트 시간 표시
            document.getElementById('last-update').textContent = `마지막 업데이트: ${new Date().toLocaleString('ko-KR')}`;
        }

        function refreshData() {
            loadDashboardData();
        }

        // 5분마다 자동 새로고침
        setInterval(loadDashboardData, 300000);
    </script>
</body>
</html>
